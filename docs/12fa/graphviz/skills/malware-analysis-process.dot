digraph MalwareAnalysisSkill {
    rankdir=TB;
    node [shape=box, style="rounded,filled", fillcolor=lightblue];
    edge [color=darkblue, penwidth=2];

    // Skill definition
    start [label="malware-analysis\nSkill Activated", fillcolor=lightgreen];

    // Phase 1: Triage & Classification
    triage_phase [label="PHASE 1: Triage & Classification", fillcolor=lightyellow, shape=box3d];
    safe_handling [label="Ensure Safe Handling\n(Isolated Environment)"];
    compute_hashes [label="Compute File Hashes\n(MD5/SHA256)"];
    initial_scan [label="Initial AV Scan\n(VirusTotal, YARA)"];
    classify_type [label="Classify Malware\nType"];

    // Phase 2: Static Analysis
    static_phase [label="PHASE 2: Static Analysis", fillcolor=lightyellow, shape=box3d];
    spawn_binary_analyst [label="Spawn Agent:\nRE-binary-analyst"];
    analyze_structure [label="Analyze Binary\nStructure"];
    extract_iocs_static [label="Extract Static IOCs\n(IPs, Domains)"];
    detect_packing [label="Detect Packing\n& Obfuscation"];
    unpack_sample [label="Unpack Sample\n(if packed)"];
    signature_analysis [label="Signature Analysis\n(YARA Rules)"];

    // Phase 3: Behavioral Analysis
    behavioral_phase [label="PHASE 3: Behavioral Analysis", fillcolor=lightyellow, shape=box3d];
    spawn_malware_analyst [label="Spawn Agent:\nRE-malware-analyst"];
    setup_sandbox [label="Setup Analysis\nSandbox"];
    execute_sample [label="Execute Sample\n(Monitored)"];

    subgraph cluster_monitoring {
        label="Concurrent Monitoring";
        style=filled;
        fillcolor=lightgrey;

        monitor_network [label="Monitor Network\nActivity"];
        monitor_files [label="Monitor File\nOperations"];
        monitor_registry [label="Monitor Registry\nChanges"];
        monitor_processes [label="Monitor Process\nCreation"];
    }

    capture_traffic [label="Capture & Analyze\nNetwork Traffic"];
    extract_iocs_dynamic [label="Extract Dynamic IOCs"];

    // Phase 4: Code Analysis
    code_analysis_phase [label="PHASE 4: Code Analysis", fillcolor=lightyellow, shape=box3d];
    decompile_cmd [label="Execute:\nRE-decompile"];
    analyze_malicious_logic [label="Analyze Malicious\nLogic"];
    identify_capabilities [label="Identify Malware\nCapabilities"];
    trace_c2_comms [label="Trace C2\nCommunications"];
    analyze_persistence [label="Analyze Persistence\nMechanisms"];
    identify_evasion [label="Identify Evasion\nTechniques"];

    // Phase 5: Threat Intelligence
    threat_intel_phase [label="PHASE 5: Threat Intelligence", fillcolor=lightyellow, shape=box3d];
    correlate_campaigns [label="Correlate with Known\nCampaigns"];
    attribute_actor [label="Attempt Attribution\n(APT Group)"];
    identify_ttps [label="Identify TTPs\n(MITRE ATT&CK)"];
    assess_impact [label="Assess Potential\nImpact"];

    // Phase 6: Reporting
    reporting_phase [label="PHASE 6: Reporting & Mitigation", fillcolor=lightyellow, shape=box3d];
    generate_report_cmd [label="Execute:\nRE-generate-report"];
    export_iocs [label="Export IOCs\n(STIX/OpenIOC)"];
    create_detection_rules [label="Create Detection\nRules (YARA/Sigma)"];
    recommend_mitigation [label="Recommend\nMitigation Steps"];

    // Integration
    memory_store [label="Store in Memory MCP\n(IOCs, TTPs, Findings)"];
    threat_intel_sharing [label="Share with Threat\nIntel Platforms"];

    // Output
    deliverables [label="Deliverables:\n- Analysis Report\n- IOC Package\n- Detection Rules\n- Mitigation Guide"];
    end [label="Malware Analysis\nComplete", fillcolor=lightcoral];

    // Flow - Triage
    start -> triage_phase;
    triage_phase -> safe_handling;
    safe_handling -> compute_hashes;
    compute_hashes -> initial_scan;
    initial_scan -> classify_type;

    // Flow - Static
    classify_type -> static_phase;
    static_phase -> spawn_binary_analyst;
    spawn_binary_analyst -> analyze_structure;
    analyze_structure -> extract_iocs_static;
    extract_iocs_static -> detect_packing;
    detect_packing -> unpack_sample [label="Packed"];
    detect_packing -> signature_analysis [label="Not Packed"];
    unpack_sample -> signature_analysis;

    // Flow - Behavioral
    signature_analysis -> behavioral_phase;
    behavioral_phase -> spawn_malware_analyst;
    spawn_malware_analyst -> setup_sandbox;
    setup_sandbox -> execute_sample;
    execute_sample -> monitor_network;
    execute_sample -> monitor_files;
    execute_sample -> monitor_registry;
    execute_sample -> monitor_processes;
    monitor_network -> capture_traffic;
    monitor_files -> extract_iocs_dynamic;
    monitor_registry -> extract_iocs_dynamic;
    monitor_processes -> extract_iocs_dynamic;
    capture_traffic -> extract_iocs_dynamic;

    // Flow - Code Analysis
    extract_iocs_dynamic -> code_analysis_phase;
    code_analysis_phase -> decompile_cmd;
    decompile_cmd -> analyze_malicious_logic;
    analyze_malicious_logic -> identify_capabilities;
    identify_capabilities -> trace_c2_comms;
    trace_c2_comms -> analyze_persistence;
    analyze_persistence -> identify_evasion;

    // Flow - Threat Intel
    identify_evasion -> threat_intel_phase;
    threat_intel_phase -> correlate_campaigns;
    correlate_campaigns -> attribute_actor;
    attribute_actor -> identify_ttps;
    identify_ttps -> assess_impact;

    // Flow - Reporting
    assess_impact -> reporting_phase;
    reporting_phase -> generate_report_cmd;
    generate_report_cmd -> export_iocs;
    export_iocs -> create_detection_rules;
    create_detection_rules -> recommend_mitigation;

    // Flow - Integration & Output
    recommend_mitigation -> memory_store;
    memory_store -> threat_intel_sharing;
    threat_intel_sharing -> deliverables;
    deliverables -> end;

    // Metadata
    label="malware-analysis Skill - Complete Workflow";
    fontsize=16;
    fontname="Arial Bold";
}
