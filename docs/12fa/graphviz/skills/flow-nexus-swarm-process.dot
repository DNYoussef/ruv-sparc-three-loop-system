digraph FLOW_NEXUS_SWARM_WORKFLOW {
  // Layout configuration
  rankdir=TB;
  node [shape=box, style="rounded,filled"];

  // =============================================================================
  // INITIALIZATION PHASE
  // =============================================================================
  subgraph cluster_initialization {
    label="Skill Initialization";
    style="filled,rounded";
    color="lightblue";
    bgcolor="#E8F4F8";

    start [label="Skill Invoked", shape=ellipse, fillcolor=lightblue];
    load_spec [label="Load skill.yaml"];
    validate_input [label="Validate Swarm\nConfiguration"];
    check_deps [label="Check Flow Nexus\nConnection"];

    start -> load_spec;
    load_spec -> validate_input;
    validate_input -> check_deps;
  }

  // =============================================================================
  // VALIDATION & POLICY ENFORCEMENT
  // =============================================================================
  subgraph cluster_validation {
    label="Policy Validation";
    style="filled,rounded";
    color="orange";
    bgcolor="#FFF8E8";

    check_policy [shape=diamond, label="12-FA\nCompliant?"];
    check_secrets [shape=diamond, label="No Secrets\nin Root?"];

    policy_violation [shape=octagon, fillcolor=crimson,
                      label="BLOCKED\nPolicy Violation"];
    secrets_violation [shape=octagon, fillcolor=crimson,
                       label="BLOCKED\nRule #1: No Secrets in Root"];
  }

  // Connect initialization to validation
  check_deps -> check_policy;
  check_policy -> check_secrets [label="Pass"];
  check_policy -> policy_violation [label="Fail"];
  check_secrets -> secrets_violation [label="Secrets Found"];

  // =============================================================================
  // EXECUTION PHASE
  // =============================================================================
  subgraph cluster_execution {
    label="Cloud Swarm Deployment";
    style="filled,rounded";
    color="purple";
    bgcolor="#F0E8F8";

    init_swarm [label="Initialize Cloud\nSwarm", fillcolor=purple];
    decision_1 [shape=diamond, label="Swarm\nInitialized?"];

    deploy_agents [label="Deploy AI Agents\nto Cloud", fillcolor=purple];
    decision_2 [shape=diamond, label="Agents\nDeployed?"];

    setup_workflow [label="Setup Event-Driven\nWorkflow", fillcolor=purple];
    decision_3 [shape=diamond, label="Workflow\nConfigured?"];

    orchestrate_tasks [label="Orchestrate Cloud\nTasks", fillcolor=purple];
    decision_4 [shape=diamond, label="Tasks\nRunning?"];

    monitor_execution [label="Monitor Swarm\nExecution", fillcolor=purple];

    // Error handling within execution
    execution_error [shape=octagon, fillcolor=orange,
                     label="Swarm Deployment Error"];
    retry_logic [label="Restart Swarm", fillcolor=yellow];
  }

  // Connect validation to execution
  check_secrets -> init_swarm [label="Pass"];

  // Execution flow
  init_swarm -> decision_1;
  decision_1 -> deploy_agents [label="Yes"];
  decision_1 -> execution_error [label="No"];

  deploy_agents -> decision_2;
  decision_2 -> setup_workflow [label="Yes"];
  decision_2 -> execution_error [label="No"];

  setup_workflow -> decision_3;
  decision_3 -> orchestrate_tasks [label="Yes"];
  decision_3 -> execution_error [label="No"];

  orchestrate_tasks -> decision_4;
  decision_4 -> monitor_execution [label="Yes"];
  decision_4 -> execution_error [label="No"];

  // Error recovery
  execution_error -> retry_logic;
  retry_logic -> init_swarm [label="Retry", style=dashed];
  retry_logic -> escalate [label="Cloud Limit"];

  // =============================================================================
  // COORDINATION & MEMORY
  // =============================================================================
  subgraph cluster_coordination {
    label="Agent Coordination";
    style="filled,rounded";
    color="blue";
    bgcolor="#E8E8F8";

    memory_store [label="Store Swarm\nMetrics", fillcolor=lightblue];
    notify_coordinator [label="Notify Cloud\nStatus", fillcolor=lightblue];
    check_dependencies [shape=diamond, label="Other Swarms\nWaiting?"];
  }

  // Connect execution to coordination
  monitor_execution -> memory_store;
  memory_store -> notify_coordinator;
  notify_coordinator -> check_dependencies;

  // =============================================================================
  // VALIDATION & QUALITY GATES
  // =============================================================================
  subgraph cluster_quality {
    label="Quality Validation";
    style="filled,rounded";
    color="green";
    bgcolor="#E8F8E8";

    validate_output [shape=diamond, label="Swarm\nHealthy?"];
    run_tests [label="Test Agent\nCommunication", fillcolor=lightgreen];
    test_results [shape=diamond, label="Communication\nOK?"];

    workflow_test [label="Test Event\nProcessing", fillcolor=lightgreen];
    workflow_check [shape=diamond, label="Events\nProcessed?"];

    quality_gate_fail [shape=octagon, fillcolor=orange,
                       label="Quality Gate Failed"];
  }

  // Connect coordination to quality
  check_dependencies -> validate_output [label="No"];

  // Quality flow
  validate_output -> run_tests [label="Yes"];
  validate_output -> quality_gate_fail [label="No"];

  run_tests -> test_results;
  test_results -> workflow_test [label="Pass"];
  test_results -> quality_gate_fail [label="Fail"];

  workflow_test -> workflow_check;
  workflow_check -> quality_gate_fail [label="Fail"];

  // =============================================================================
  // COMPLETION & CLEANUP
  // =============================================================================
  subgraph cluster_completion {
    label="Completion";
    style="filled,rounded";
    color="green";
    bgcolor="#E8F8E8";

    cleanup [label="Cleanup Cloud\nResources", fillcolor=lightgreen];
    log_completion [label="Log Swarm\nMetrics"];
    success [label="Skill Complete", shape=doublecircle,
             fillcolor=green, style="filled,bold"];
  }

  // Connect quality to completion
  workflow_check -> cleanup [label="Pass"];
  cleanup -> log_completion;
  log_completion -> success;

  // =============================================================================
  // ERROR ESCALATION PATH
  // =============================================================================
  subgraph cluster_errors {
    label="Error Handling & Escalation";
    style="filled,rounded";
    color="red";
    bgcolor="#F8E8E8";

    escalate [shape=hexagon, fillcolor=yellow,
              label="Escalate to User"];
    log_error [label="Log Error Details", fillcolor=orange];
    rollback [label="Terminate Swarm", fillcolor=orange];
    failure [label="Skill Failed", shape=doublecircle,
             fillcolor=red, style="filled,bold"];
  }

  // Error escalation flow
  escalate -> log_error;
  quality_gate_fail -> log_error;
  policy_violation -> log_error;
  secrets_violation -> log_error;

  log_error -> rollback;
  rollback -> failure;
}
