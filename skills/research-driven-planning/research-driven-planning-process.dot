digraph DiscoveryPlanningLoop {
    rankdir=TB;
    compound=true;
    node [shape=box, style=filled, fontname="Arial"];
    edge [fontname="Arial"];

    // Start and end with semantic ellipse
    start [shape=ellipse, label="Start:\nNew Feature/Project", fillcolor=lightgreen];
    end [shape=ellipse, label="Complete:\nRisk-Mitigated Plan", fillcolor=green, fontcolor=white];

    // SOP Phase 1: Specification
    subgraph cluster_specification {
        label="SOP Phase 1: Specification";
        fillcolor=lightyellow;
        style=filled;

        spec1 [label="Create\nSPEC.md"];
        spec2 [label="Store in Memory\n(loop1/specification)"];
        spec1 -> spec2;
    }

    // SOP Phase 2: Research
    subgraph cluster_research {
        label="SOP Phase 2: Research (30-60% time savings)";
        fillcolor=lightblue;
        style=filled;

        research1 [label="Web Research\n(/research:web)"];
        research2 [label="GitHub Analysis\n(/research:github)"];
        research3 [label="Synthesize Findings\n(/research:analyze)"];
        research4 [label="Store Research\n(loop1/research)"];

        research1 -> research3;
        research2 -> research3;
        research3 -> research4;
    }

    // SOP Phase 3: Planning
    subgraph cluster_planning {
        label="SOP Phase 3: Planning";
        fillcolor=lightcyan;
        style=filled;

        plan1 [label="Convert SPEC→Plan\n(/spec:plan)"];
        plan2 [label="Enhance with\nResearch"];
        plan3 [label="Store Enhanced Plan\n(loop1/planning)"];

        plan1 -> plan2;
        plan2 -> plan3;
    }

    // SOP Phase 4: Execution (Pre-mortem Loop)
    subgraph cluster_premortem {
        label="SOP Phase 4: Execution (5x Pre-mortem)";
        fillcolor=lightsalmon;
        style=filled;

        pm_start [shape=ellipse, label="Pre-mortem\nIteration 1", fillcolor=yellow];
        pm1 [label="Identify\nFailure Modes"];
        pm2 [label="Root Cause\nAnalysis"];
        pm3 [label="Mitigation\nStrategies"];
        pm4 [label="Enhance Plan"];
        pm_decision [shape=diamond, label="Confidence\n<3%?", fillcolor=yellow];
        pm_iterate [label="Next Iteration\n(2-5)", fillcolor=orange];

        pm_start -> pm1;
        pm1 -> pm2;
        pm2 -> pm3;
        pm3 -> pm4;
        pm4 -> pm_decision;
        pm_decision -> pm_iterate [label="no\n(>3%)", color=red];
        pm_iterate -> pm1 [style=dashed];
    }

    // SOP Phase 5: Knowledge
    subgraph cluster_knowledge {
        label="SOP Phase 5: Knowledge Package";
        fillcolor=lightgreen;
        style=filled;

        know1 [label="Generate\nPlanning Package"];
        know2 [label="Store for Loop 2\n(loop1-to-loop2)"];
        know3 [label="Store Baseline\n(loop3-feedback)"];
        know4 [label="Generate\nLoop 1 Report"];

        know1 -> know2;
        know2 -> know3;
        know3 -> know4;
    }

    // External references
    loop2 [shape=cylinder, label="Loop 2:\nDevelopment Swarm", fillcolor=lightcoral];
    loop3_feedback [shape=cylinder, label="Loop 3:\nFailure Patterns\n(Historical)", fillcolor=lightcoral];

    // Main flow with labeled edges
    start -> spec1 [lhead=cluster_specification];
    spec2 -> research1 [ltail=cluster_specification, lhead=cluster_research];
    research4 -> plan1 [ltail=cluster_research, lhead=cluster_planning];
    plan3 -> pm_start [ltail=cluster_planning, lhead=cluster_premortem];
    pm_decision -> know1 [label="yes\n(<3%)", color=green, lhead=cluster_knowledge];
    know4 -> end [ltail=cluster_knowledge];

    // Integration points
    end -> loop2 [label="feeds\nplanning package", style=dashed, color=blue];
    loop3_feedback -> pm1 [label="uses\nhistorical failures", style=dashed, color=purple];

    // Critical checkpoints
    validate [shape=octagon, label="VALIDATION:\nAll requirements\ncovered?", fillcolor=orange];
    plan3 -> validate [style=dashed];
    validate -> pm_start [label="yes", color=green];
    validate -> spec1 [label="no\n(revise)", color=red, style=dashed];

    labelloc="t";
    label="Loop 1: Discovery & Planning Process\nSpecification → Research → Planning → Execution (5x Pre-mortem) → Knowledge";
    fontsize=16;
    fontname="Arial Bold";
}
